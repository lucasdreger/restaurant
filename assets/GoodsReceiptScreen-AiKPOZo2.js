import{u as q,j as e,c as j,t as b}from"./index-DUOUId27.js";import{r as u}from"./vendor-state-CIiacWcF.js";import{A as B,P as O,a7 as Y,a8 as _,a9 as J,X as M,i as R,T as D,L as P,B as z,$ as G,t as V,o as $,U as K,m as Q}from"./vendor-ui-tYsHGQF9.js";import"./vendor-react-qkC6yhPU.js";import"./vendor-pdf-BScUNyKw.js";import"./vendor-supabase-CywEAasM.js";const X="your_openai_api_key_here";async function H(d){return new Promise((o,r)=>{const l=new FileReader;l.onload=()=>o(l.result),l.onerror=r,l.readAsDataURL(d)})}async function W(d){console.log("ðŸ” Starting OpenAI Vision OCR processing...");try{const o=await H(d);console.log("ðŸ“¸ Image converted to base64");const r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${X}`},body:JSON.stringify({model:"gpt-4o",messages:[{role:"system",content:`You are an expert invoice/delivery note parser for a restaurant kitchen. 
Extract the following information from the invoice image and return it as valid JSON:

{
  "supplier": "Company name of the supplier",
  "invoiceNumber": "Invoice or delivery note number",
  "invoiceDate": "Date in YYYY-MM-DD format",
  "items": [
    {
      "name": "Product name",
      "quantity": "Numeric quantity as string",
      "unit": "Unit (kg, g, l, ml, pcs, box, case, etc.)"
    }
  ],
  "rawText": "Brief summary of what you see on the invoice"
}

Rules:
- Extract ALL line items you can find
- Normalize units: kg, g, l, ml, pcs, box, case
- If quantity and unit are combined (e.g., "2.5kg"), separate them
- For items without clear units, use "pcs"
- Dates should be converted to YYYY-MM-DD format
- If you cannot find a field, use null
- Return ONLY valid JSON, no markdown or explanations`},{role:"user",content:[{type:"text",text:"Please extract all invoice data from this image. Focus on supplier name, invoice number, date, and all line items with their quantities and units."},{type:"image_url",image_url:{url:o,detail:"high"}}]}],max_tokens:2e3,temperature:.1})});if(!r.ok){const n=await r.text();throw console.error("OpenAI API error:",n),new Error(`OpenAI API error: ${r.status}`)}const c=(await r.json()).choices?.[0]?.message?.content;if(!c)throw new Error("No content in OpenAI response");console.log("ðŸ“„ OpenAI Response:",c);let i;try{const n=c.replace(/```json\n?|\n?```/g,"").trim();i=JSON.parse(n)}catch(n){console.error("JSON parse error:",n);const g=c.match(/\{[\s\S]*\}/);if(g)i=JSON.parse(g[0]);else throw new Error("Could not parse JSON from response")}const p=(i.items||[]).map(n=>({id:crypto.randomUUID(),name:n.name||"Unknown Item",quantity:String(n.quantity||"1"),unit:Z(n.unit||"pcs"),temperature:void 0}));return console.log("âœ… Extracted",p.length,"items"),{supplier:i.supplier||null,invoiceNumber:i.invoiceNumber||null,invoiceDate:i.invoiceDate||null,items:p,rawText:i.rawText||c.substring(0,500),confidence:95}}catch(o){throw console.error("OpenAI Vision OCR error:",o),o}}function Z(d){const o={kilogram:"kg",kilograms:"kg",kilo:"kg",gram:"g",grams:"g",litre:"l",liter:"l",litres:"l",liters:"l",millilitre:"ml",milliliter:"ml",piece:"pcs",pieces:"pcs",pc:"pcs",each:"pcs",ea:"pcs",unit:"pcs",units:"pcs",case:"box",cases:"box",boxes:"box"},r=(d||"pcs").toLowerCase().trim();return o[r]||r}const F={supplier:"",invoiceNumber:"",invoiceDate:new Date().toISOString().split("T")[0],items:[],receivedBy:"",receivedAt:new Date().toISOString().slice(0,16),overallTemperature:"",notes:""};function ne({onBack:d}){const{staffMembers:o}=q(),[r,l]=u.useState(F),[c,i]=u.useState(!1),[p,n]=u.useState(!1),[g,k]=u.useState(null),[f,I]=u.useState(null),C=u.useRef(null),T=u.useRef(null),A=async t=>{const s=t.target.files?.[0];if(s){i(!0);try{const a=new FileReader;a.onload=async w=>{const y=w.target?.result;k(y);const m=await W(s);m&&(l(v=>({...v,supplier:m.supplier||v.supplier,invoiceNumber:m.invoiceNumber||v.invoiceNumber,invoiceDate:m.invoiceDate||v.invoiceDate,items:m.items.length>0?m.items:v.items})),I(m.confidence),m.confidence>70?b.success(`Invoice scanned! ${m.items.length} items detected.`):b.info("Invoice scanned with low confidence. Please verify extracted data."))},a.readAsDataURL(s)}catch(a){console.error("OCR error:",a),b.error("Failed to scan invoice. Please enter details manually.")}finally{i(!1)}}},x=(t,s)=>{l(a=>({...a,[t]:s}))},U=()=>{const t={id:crypto.randomUUID(),name:"",quantity:"",unit:"kg",temperature:""};l(s=>({...s,items:[...s.items,t]}))},N=(t,s,a)=>{l(w=>({...w,items:w.items.map(y=>y.id===t?{...y,[s]:a}:y)}))},E=t=>{l(s=>({...s,items:s.items.filter(a=>a.id!==t)}))},S=()=>r.supplier.trim()&&r.receivedBy&&r.items.length>0&&r.items.every(t=>t.name.trim()&&t.quantity.trim()),L=async()=>{if(!S()){b.error("Please fill in all required fields");return}n(!0);try{console.log("ðŸ“¦ Goods Receipt:",r),b.success("Goods receipt recorded successfully!"),l(F),k(null),I(null)}catch(t){console.error("Submit error:",t),b.error("Failed to save receipt")}finally{n(!1)}},h=t=>{const s=parseFloat(t);return isNaN(s)?null:s<=5};return e.jsxs("div",{className:"min-h-full bg-theme-primary text-theme-primary pb-20 lg:pb-6",children:[e.jsx("div",{className:"bg-theme-card border-b border-theme-primary px-4 py-4 sticky top-0 z-10",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex items-center gap-4",children:[e.jsx("button",{onClick:d,className:"lg:hidden p-2 -ml-2 rounded-xl hover:bg-theme-ghost transition-colors text-theme-secondary hover:text-theme-primary",children:e.jsx(B,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"text-xl font-bold flex items-center gap-2 text-theme-primary",children:[e.jsx(O,{className:"w-6 h-6 text-emerald-500"}),"Goods Receipt"]}),e.jsx("p",{className:"text-sm text-theme-muted",children:"Scan invoice & record delivery"})]})]})}),e.jsxs("div",{className:"max-w-4xl mx-auto p-4 space-y-6",children:[e.jsxs("div",{className:"bg-theme-card rounded-2xl border border-theme-primary p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-theme-primary",children:[e.jsx(Y,{className:"w-5 h-5 text-cyan-500"}),"Scan Invoice"]}),g?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:g,alt:"Scanned invoice",className:"w-full max-h-64 object-contain rounded-xl bg-black/20"}),e.jsx("button",{onClick:()=>{k(null),I(null)},className:"absolute top-2 right-2 p-2 bg-black/50 rounded-lg hover:bg-black/70 transition-colors",children:e.jsx(M,{className:"w-4 h-4"})})]}),f!==null&&e.jsxs("div",{className:j("flex items-center gap-2 px-4 py-2 rounded-lg text-sm",f>70?"bg-emerald-500/20 text-emerald-400":"bg-amber-500/20 text-amber-400"),children:[f>70?e.jsx(R,{className:"w-4 h-4"}):e.jsx(D,{className:"w-4 h-4"}),e.jsxs("span",{children:["OCR Confidence: ",f.toFixed(0),"%",f<=70&&" - Please verify extracted data"]})]}),e.jsx("button",{onClick:()=>C.current?.click(),className:"w-full py-2 bg-theme-secondary rounded-lg text-sm hover:bg-theme-ghost transition-colors text-theme-primary",children:"Scan Different Invoice"})]}):e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("button",{onClick:()=>T.current?.click(),disabled:c,className:"flex-1 p-6 bg-theme-secondary rounded-xl border-2 border-dashed border-theme-primary hover:border-emerald-500 transition-colors flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-emerald-500/20 flex items-center justify-center",children:e.jsx(_,{className:"w-7 h-7 text-emerald-500"})}),e.jsx("span",{className:"font-medium text-theme-primary",children:"Take Photo"}),e.jsx("span",{className:"text-sm text-theme-muted",children:"Use camera to scan invoice"})]}),e.jsxs("button",{onClick:()=>C.current?.click(),disabled:c,className:"flex-1 p-6 bg-theme-secondary rounded-xl border-2 border-dashed border-theme-primary hover:border-cyan-500 transition-colors flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-cyan-500/20 flex items-center justify-center",children:e.jsx(J,{className:"w-7 h-7 text-cyan-500"})}),e.jsx("span",{className:"font-medium text-theme-primary",children:"Upload File"}),e.jsx("span",{className:"text-sm text-theme-muted",children:"Select image from device"})]}),e.jsx("input",{ref:T,type:"file",accept:"image/*",capture:"environment",onChange:A,className:"hidden"}),e.jsx("input",{ref:C,type:"file",accept:"image/*,.pdf",onChange:A,className:"hidden"})]}),c&&e.jsxs("div",{className:"mt-4 flex items-center justify-center gap-3 py-8",children:[e.jsx(P,{className:"w-6 h-6 animate-spin text-emerald-500"}),e.jsx("span",{className:"text-theme-muted",children:"Processing invoice..."})]})]}),e.jsxs("div",{className:"bg-theme-card rounded-2xl border border-theme-primary p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-theme-primary",children:[e.jsx(z,{className:"w-5 h-5 text-purple-500"}),"Supplier Details"]}),e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-theme-muted block mb-1.5",children:"Supplier Name *"}),e.jsx("input",{type:"text",value:r.supplier,onChange:t=>x("supplier",t.target.value),placeholder:"e.g., Fresh Foods Ltd",className:"w-full px-4 py-3 bg-theme-secondary border border-theme-primary rounded-xl text-theme-primary placeholder:text-theme-muted focus:outline-none focus:border-emerald-500 transition-colors"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-theme-muted block mb-1.5",children:"Invoice Number"}),e.jsx("input",{type:"text",value:r.invoiceNumber,onChange:t=>x("invoiceNumber",t.target.value),placeholder:"e.g., INV-2026-001234",className:"w-full px-4 py-3 bg-theme-secondary border border-theme-primary rounded-xl text-theme-primary placeholder:text-theme-muted focus:outline-none focus:border-emerald-500 transition-colors"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-theme-muted block mb-1.5",children:"Invoice Date"}),e.jsx("input",{type:"date",value:r.invoiceDate,onChange:t=>x("invoiceDate",t.target.value),className:"w-full px-4 py-3 bg-theme-secondary border border-theme-primary rounded-xl text-theme-primary focus:outline-none focus:border-emerald-500 transition-colors"})]})]})]}),e.jsxs("div",{className:"bg-theme-card rounded-2xl border border-theme-primary p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 text-theme-primary",children:[e.jsx(G,{className:"w-5 h-5 text-amber-500"}),"Items Received"]}),e.jsxs("button",{onClick:U,className:"flex items-center gap-2 px-4 py-2 bg-emerald-500/20 text-emerald-400 rounded-xl hover:bg-emerald-500/30 transition-colors text-sm font-medium",children:[e.jsx(V,{className:"w-4 h-4"}),"Add Item"]})]}),r.items.length===0?e.jsxs("div",{className:"text-center py-8 text-theme-muted",children:[e.jsx(O,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No items added yet"}),e.jsx("p",{className:"text-sm",children:"Scan an invoice or add items manually"})]}):e.jsx("div",{className:"space-y-3",children:r.items.map((t,s)=>e.jsx("div",{className:"p-4 bg-theme-secondary rounded-xl border border-theme-primary",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"w-6 h-6 rounded-full bg-emerald-500/20 text-emerald-500 flex items-center justify-center text-sm font-bold flex-shrink-0 mt-2",children:s+1}),e.jsxs("div",{className:"flex-1 grid sm:grid-cols-4 gap-3",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-xs text-theme-muted block mb-1",children:"Item Name *"}),e.jsx("input",{type:"text",value:t.name,onChange:a=>N(t.id,"name",a.target.value),placeholder:"e.g., Chicken Breast",className:"w-full px-3 py-2 bg-theme-card border border-theme-primary rounded-lg text-sm text-theme-primary focus:outline-none focus:border-emerald-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-theme-muted block mb-1",children:"Quantity *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:t.quantity,onChange:a=>N(t.id,"quantity",a.target.value),placeholder:"5",className:"w-full px-3 py-2 bg-theme-card border border-theme-primary rounded-lg text-sm text-theme-primary focus:outline-none focus:border-emerald-500"}),e.jsxs("select",{value:t.unit,onChange:a=>N(t.id,"unit",a.target.value),className:"w-20 px-2 py-2 bg-theme-card border border-theme-primary rounded-lg text-sm text-theme-primary focus:outline-none focus:border-emerald-500",children:[e.jsx("option",{value:"kg",children:"kg"}),e.jsx("option",{value:"g",children:"g"}),e.jsx("option",{value:"l",children:"L"}),e.jsx("option",{value:"ml",children:"ml"}),e.jsx("option",{value:"pcs",children:"pcs"}),e.jsx("option",{value:"box",children:"box"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-theme-muted block mb-1",children:"Temp (Â°C)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:t.temperature||"",onChange:a=>N(t.id,"temperature",a.target.value),placeholder:"3.5",className:j("w-full px-3 py-2 bg-theme-card border rounded-lg text-sm text-theme-primary focus:outline-none",t.temperature&&h(t.temperature)===!1?"border-red-500 text-red-400":"border-theme-primary focus:border-emerald-500")}),t.temperature&&h(t.temperature)!==null&&e.jsx("div",{className:j("absolute right-2 top-1/2 -translate-y-1/2",h(t.temperature)?"text-emerald-500":"text-red-500"),children:h(t.temperature)?e.jsx(R,{className:"w-4 h-4"}):e.jsx(D,{className:"w-4 h-4"})})]})]})]}),e.jsx("button",{onClick:()=>E(t.id),className:"p-2 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors",children:e.jsx($,{className:"w-4 h-4"})})]})},t.id))})]}),e.jsxs("div",{className:"bg-theme-card rounded-2xl border border-theme-primary p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-theme-primary",children:[e.jsx(K,{className:"w-5 h-5 text-blue-500"}),"Reception Details"]}),e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-theme-muted block mb-1.5",children:"Received By *"}),e.jsxs("select",{value:r.receivedBy,onChange:t=>x("receivedBy",t.target.value),className:"w-full px-4 py-3 bg-theme-secondary border border-theme-primary rounded-xl text-theme-primary focus:outline-none focus:border-emerald-500 transition-colors",children:[e.jsx("option",{value:"",children:"Select staff member..."}),o.filter(t=>t.active).map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",t.initials,")"]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-theme-muted block mb-1.5",children:"Received At"}),e.jsx("input",{type:"datetime-local",value:r.receivedAt,onChange:t=>x("receivedAt",t.target.value),className:"w-full px-4 py-3 bg-theme-secondary border border-theme-primary rounded-xl text-theme-primary focus:outline-none focus:border-emerald-500 transition-colors"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm text-theme-muted block mb-1.5 flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4 text-cyan-500"}),"Overall Temperature (Â°C)"]}),e.jsx("input",{type:"text",value:r.overallTemperature,onChange:t=>x("overallTemperature",t.target.value),placeholder:"e.g., 3.5",className:j("w-full px-4 py-3 bg-theme-secondary border rounded-xl text-theme-primary placeholder:text-theme-muted focus:outline-none transition-colors",r.overallTemperature&&h(r.overallTemperature)===!1?"border-red-500":"border-theme-primary focus:border-emerald-500")}),r.overallTemperature&&h(r.overallTemperature)===!1&&e.jsxs("p",{className:"text-xs text-red-400 mt-1 flex items-center gap-1",children:[e.jsx(D,{className:"w-3 h-3"}),"Temperature exceeds safe limit (5Â°C for chilled goods)"]})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-sm text-theme-muted block mb-1.5",children:"Notes"}),e.jsx("textarea",{value:r.notes,onChange:t=>x("notes",t.target.value),placeholder:"Any observations, damaged items, discrepancies...",rows:3,className:"w-full px-4 py-3 bg-theme-secondary border border-theme-primary rounded-xl text-theme-primary placeholder:text-theme-muted focus:outline-none focus:border-emerald-500 transition-colors resize-none"})]})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:d,className:"px-6 py-4 bg-theme-card border border-theme-primary rounded-xl font-semibold text-theme-primary hover:bg-theme-secondary transition-colors",children:"Cancel"}),e.jsx("button",{onClick:L,disabled:!S()||p,className:j("flex-1 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all text-white",S()&&!p?"bg-gradient-to-r from-emerald-500 to-cyan-500 hover:shadow-lg hover:shadow-emerald-500/30":"bg-theme-secondary text-theme-muted cursor-not-allowed"),children:p?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-5 h-5 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-5 h-5"}),"Record Receipt"]})})]})]})]})}export{ne as GoodsReceiptScreen};
